\section{$S_3$ bound}\label{s_3chapter}
\begin{proposition}[Preliminary bound on $S_3$]\label{s_3bound}
    We have \[
    S_3 \lesssim \Big(\frac{\phi(q)}{q}\Big)^2 (qT)^2 E(\mathcal{S})^{1/2} |\mathcal{S}|^{1/2}.
    \]
\end{proposition}
Recall that \begin{align*}
	I_m\defeq\frac{N^3}{q^3}\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2),\\(t_3,\chi_3)\in\mathcal{S}}} &\sum_{x\in (\mathbb{Z}/q\mathbb{Z})^3}\chi_1\bar{\chi}_3(x_1)\chi_2\bar{\chi}_1(x_2)\chi_3\bar{\chi}_2(x_3) e\left(\frac{-x\cdot m}{q}\right)\\
	\times \ &\hat{h}_{t_1-t_3}\left(\frac{Nm_1}{q}\right)\hat{h}_{t_2-t_1}\left(\frac{Nm_2}{q}\right)\hat{h}_{t_3-t_2}\left(\frac{Nm_3}{q}\right).
\end{align*}

By non-stationary phase, $I_m$ is negligible for the terms $qT/N\lesssim |m|$, so 
\begin{equation}
    S_3 = \sum_{0<|m_1|,|m_2|,|m_3|\lesssim qT/N} I_m + O(T^{-100}).
\end{equation}
Furthermore, by symmetry in $m_1$, $m_2$, $m_3$, we can consider the terms $|m_1|\leq |m_2|\leq |m_3|$ at a cost of a factor of $6$.
We first consider the triple summation in $\mathbb{Z}/q$. Define \begin{align*}
    A_{m,\chi_1,\chi_2,\chi_3}&\defeq \sum_{x\in (\mathbb{Z}/q\mathbb{Z})^3}\chi_1\bar{\chi}_3(x_1)\chi_2\bar{\chi}_1(x_2)\chi_3\bar{\chi}_2(x_3) e\left(\frac{-x\cdot m}{q}\right),
\end{align*}
which is the inner summation in $I_m$.
Notice that $\chi(0)=0$, so we can define the summation in $A$ to run over $(\mathbb{Z}/q\mathbb{Z})^\times$ to get 
\begin{align*}
    A_{m,\chi_1,\chi_2,\chi_3}&= \sum_{x\in ((\mathbb{Z}/q\mathbb{Z})^\times)^3}\chi_1\bar{\chi}_3(x_1)\chi_2\bar{\chi}_1(x_2)\chi_3\bar{\chi}_2(x_3) e\left(\frac{-x\cdot m}{q}\right)\\
\end{align*}
We now make the substitution $y_1=x_1x_3^{-1}, y_2=x_2x_3^{-1} \mod q$ for the summation over $x$.
We thus rewrite the sum over $x$ as 
\begin{align*}
    &\sum_{y_1,y_2,x_3\in (\mathbb{Z}/q\mathbb{Z})^\times}
    \chi_1(y_1y_2^{-1})\chi_2(y_2)\chi_3(y_1^{-1})e\left(\frac{-(y_1m_1+y_2m_2+m_3)x_3}{q}\right)\\
    =&
    \sum_{y_1,y_2\in (\mathbb{Z}/q\mathbb{Z})^\times}\chi_1(y_1)\bar{\chi}_1(y_2)\chi_2(y_2)\bar{\chi}_3(y_1)\sum_{x_3\in (\mathbb{Z}/q\mathbb{Z})^\times}e\left(\frac{-(y_1m_1+y_2m_2+m_3)x_3}{q}\right)
\end{align*}
Now we can apply M\"obius inversion on the summation in $x_3$ to get \begin{align*}
   \sum_{x_3\in (\mathbb{Z}/q\mathbb{Z})^\times}e\left(\frac{-(y_1m_1+y_2m_2+m_3)x_3}{q}\right)=& \sum_{q_0|q} \mu\left(\frac{q}{q_0}\right)\sum_{\tilde{x}_3\in \mathbb{Z}/q_0}e\left(\frac{-(y_1m_1+y_2m_2+m_3)\tilde{x}_3}{q_0}\right) \\ =& \sum_{q_0|q} \mu\left(\frac{q}{q_0}\right) q_0 \mathbb{I}_{q_0|(y_1m_1+y_2m_2+m_3)}.
\end{align*}

With this in mind, we break $I_m=\sum_{q_0|q}\mu(q/q_0)I_{m,q_0}$,\begin{align*}
I_{m,q_0}\defeq&\frac{N^3q_0}{q^2}\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2),\\(t_3,\chi_3)\in\mathcal{S}}} \sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} \\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\chi_1(y_1)\bar{\chi}_1(y_2)\chi_2(y_2)\bar{\chi}_3(y_1)\\
&\times \hat{h}_{t_1-t_3}\left(\frac{Nm_1}{q}\right)\hat{h}_{t_2-t_1}\left(\frac{Nm_2}{q}\right)\hat{h}_{t_3-t_2}\left(\frac{Nm_3}{q}\right).
\end{align*}
\begin{proposition} [Divisor reduction of $S_3$] \label{divisorreduction}We have\[
    S_3 \lesssim \sup_{q_0|q}\quad \sum_{\substack{0<|m_1|,|m_2|,\\|m_3|\lesssim qT/N}} I_{m,q_0}.
    \]
\end{proposition}
\begin{proof}
    We split the sum in $I_m$ to be across $I_{m,q_0}$ for each divisor of $q$. The divisor function grows slower than any power of $q$, so gives the proposition.
\end{proof}
We then consider the subproduct in $I_{m,q_0}$: \[
	\hat{h}_{t_1-t_3}\left(\frac{Nm_1}{q}\right)\hat{h}_{t_2-t_1}\left(\frac{Nm_2}{q}\right)\hat{h}_{t_3-t_2}\left(\frac{Nm_3}{q}\right).
\]
Expanding the Fourier transform as an integral, this expression equals \begin{align*}
	 &\int_{\reals^3}\mathbf{\tilde{\omega}}(\mathbf{u})u_1^{i(t_1-t_3)}u_2^{i(t_2-t_1)}u_3^{i(t_3-t_2)}e\left(\frac{-N\mathbf{m}\cdot \mathbf{u}}{q}\right)d\mathbf{u}\\
	 =&\int_{\reals^3}\mathbf{\tilde{\omega}}(\mathbf{u})\left(\frac{u_1}{u_2}\right)^{it_1}\left(\frac{u_2}{u_3}\right)^{it_2}\left(\frac{u_3}{u_1}\right)^{it_3}
	 e\left(\frac{-N\mathbf{m}\cdot \mathbf{u}}{q}\right)d\mathbf{u}
	 \end{align*}
	 where $\tilde{\omega}(u_1,u_2,u_3)\defeq \omega(u_1)^2\omega(u_2)^2\omega(u_3)^2$ is compactly supported. The observation is that the choice of $u_1/u_2$ and $u_2/u_3$ fixes $u_3/u_1$, so this triple integral can be rewritten in two variables. We change variables $v_1=u_1/u_3,v_2=u_2/u_3$ for the integral, which is well defined on the support of $\tilde{\omega}$. This gives us a Jacobian of $u_3^2$ and equals
	 \begin{equation}\label{im1integral}
        \begin{split}
	&\int_{\reals^3}\tilde{\omega}(v_1u_3,v_2u_3,u_3) {\left(\frac{v_1}{v_2}\right)}^{it_1} {\left(v_2\right)}^{it_2}{\left(\frac{1}{v_1}\right)}^{it_3} u_3^2 \ e\left(\frac{-N(v_1m_1+v_2m_2+m_3)u_3}{q}\right)\ dv_1\ dv_2\ du_3\\
	=&\int_{\reals^2}\int_\reals u_3^2 \ \tilde{\omega}(v_1u_3,v_2u_3,u_3) e\left(\frac{-N(v_1m_1+v_2m_2+m_3)u_3}{q}\right)  du_3 \ {\left(\frac{v_1}{v_2}\right)}^{it_1} {\left(v_2\right)}^{it_2}{\left(\frac{1}{v_1}\right)}^{it_3}  \ dv_1\ dv_2.\\
     \end{split}
\end{equation}
We define \begin{align*}
	R(v,n_1,n_2)&\defeq \sum_{(t,\chi)\in \mathcal{S}} 
	\chi({n_1})\bar{\chi}(n_2)v^{it},\\
	R(v,n)&\defeq R(v,n,1).
\end{align*}
Therefore, \begin{equation*}
    I_{m,q_0} = \frac{N^3q_0}{q^3} \sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} \\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\int_{\reals^2} \tilde{I}_{u_3}(v_1,v_2)  R{\left(\frac{v_1}{v_2},y_1,y_2\right)}R {\left(v_2,y_2\right)}R{\left(\frac{1}{v_1},y_1^{-1}\right)} \ dv_1\ dv_2,
\end{equation*}
    where\[
     \tilde{I}_{u_3}(v_1,v_2)\defeq \tilde{I}_{u_3}(v_1,v_2,m)\defeq \int_\reals u_3^2 \ \tilde{\omega}(v_1u_3,v_2u_3,u_3) e\left(\frac{-N(v_1m_1+v_2m_2+m_3)u_3}{q}\right)  du_3.\]
The innermost integral $\tilde{I}_{u_3}(v_1,v_2)$ has cancellation property. By the principle of non-stationary phase through repeated integration by parts, this integral is $O_{\epsilon, A}(T^{-A})$ for any $|v_1m_1+v_2m_2+m_3|>qT^\epsilon/N$. Therefore, we can truncate the domain of the integrals in $v_1$ and $v_2$ to  $|v_1m_1+v_2m_2+m_3|\lesssim q/N$ with negligible error. On this domain, the innermost integral in $u_3$ is $O(1)$ by the trivial bound. Moreover, by the compact support of $\tilde{\omega}$ on $[1,2]\times [1,2]\times [1,2]$  the integrand of innermost integral is non-zero only if \[
v_1u_3,v_2u_3,u_3\sim N.
\]
Importantly, this requires $1/2 \leq v_1,v_2 \leq 2$, so we can further restrict the outermost integrals to this region. 
We therefore have: 
\begin{proposition}[Simplification of $I_{m,q_0}$ domain] \label{domainreduction}
    \[
    |I_{m,q_0}|\ll \frac{N^3q_0}{q^3}\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} \\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\int\displaylimits_{\substack{
        |v_1m_1+v_2m_2+m_3|\lesssim \frac{q}{N}\\
        \frac{1}{2}\leq v_1,v_2\leq 2
}}  R{\left(\frac{v_1}{v_2},y_1,y_2\right)}R {\left(v_2,y_2\right)}R{\left(\frac{1}{v_1},y_1^{-1}\right)} \ dv_1\ dv_2+O_{\epsilon}(T^{-100}).
    \]
    Moreover, if $|m_1|\leq|m_2|\leq |m_3|$, $|I_{m,q_0}|=O(T^{-100})$ unless $|m_2|\asymp|m_3|$.
\end{proposition}
\begin{proof}
    The first statement is a result of our work so far. The second part of the proposition follows from the integral bounds $|v_1m_1+v_2m_2+m_3|\lesssim q/N$
    and $v_1,v_2\asymp 1$. When $|m_1|\leq |m_2|$, we have $|v_1m_1+v_2m_2|=O(|m_2|)$. These force $|m_2| \asymp|m_3|$, or else the integral will be negligible as the domain of the integration will be outside the range $|v_1m_1+v_2m_2+m_3|\lesssim q/N$.
\end{proof}
When $|m_2|\asymp|m_3|$, the domain of integration can be written as\begin{align*}
    |v_1m_1+v_2m_2+m_3|\lesssim \frac{q}{N} \implies \left|v_2 - \frac{v_1m_1+m_3}{-m_2}\right|\lesssim \frac{q}{|m_2|N} \asymp \frac{q}{|m_3|N}.
\end{align*}
Thus, if we fix $v_1$, the integration in $v_2$ is in a ${q}/{(|m_3|N)}$-small neighborhood of $\frac{v_1m_1+m_3}{-m_2}$. In principle, we can estimate the value of the integral by evalulating at 
$v_2 = {v_1m_1+m_3}/{-m_2}$ and multiplying it by $q/(|m_3|N)$. This is made precise by splitting the sum across $m_3$ into dyadic interals $M$, and smoothing over ranges of ${q}/{(MN)}$.

Let $\tilde{\phi}$ be a smooth bump function such that equals $\tilde{\phi}=1$ on $|x|\lesssim 1$ and is supported in $|x|\lesssim 1$ (with a larger constant), so that $\|\tilde{\phi}^{(j)}\lesssim_j 1\|$ for all $j$.
We define \[
\tilde{R}_M(v,y_1,y_2) \defeq  \left( \int \frac{NM}{q}\tilde{\phi}\left(\frac{NM}{q}(v-v')\right)|R(v',y_1,y_2)|^2 dv'\right)^{1/2}.
\]
\begin{proposition} \label{dyadics_3}
    Let \[
    \tilde{I}_{m,y_1,y_2,q_0}\defeq \tilde{I}_{m,q_0}\defeq \ \int_{v_1\asymp 1} \left| \tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2v_1},y_2,y_1\right)
    \tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2},y_2\right)R\left(v_1,y_1\right)\right| dv_1.
    \]
    There is a choice of $q_0|q$ and $0<M_1\leq M \lesssim qT/N$ such that \[
        S_3\lesssim \frac{N^2q_0}{Mq^2}\sum_{|m_1|\sim M_1,|m_2|,|m_3|\sim M}\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} \\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\tilde{I}_{m,q_0}+O(T^{-100}).
    \]
\end{proposition}


\begin{proof}
By Proposition \ref{divisorreduction}, we consider the terms $|m_1|\leq |m_2|\leq|m_3|$ at the cost of a factor of $6$. By Proposition \ref{domainreduction}, we add the condition that $|m_2|\asymp|m_3|$. Expanding the sum over $m_1,m_2,m_3$ dyadically, we get for some $M_1\leq M \lesssim qT/N $ and for the value of $q_0$ that achieves supremum. \begin{align*}
    S_3\lesssim \sum_{|m_1|\sim M_1,|m_2|,|m_3|\sim M}|I_{m,q_0}| + O(T^{-100}).
\end{align*}

We now consider
\begin{align*} 
    & \int\displaylimits_{\substack{
        |v_1m_1+v_2m_2+m_3|\lesssim \frac{q}{N}\\
        \frac{1}{2}\leq v_1,v_2\leq 2
    }} \left| R\left(\frac{v_2}{v_1},y_2,y_1\right)
    R(v_2,y_2)R\left(\frac{1}{v_1},y_1^{-1}\right)\right| dv_1 \ dv_2\\
    = 
   & \int\displaylimits_{\substack{
        |v_1m_1+v_2m_2+m_3|\lesssim \frac{q}{N}\\
        \frac{1}{2}\leq v_1,v_2\leq 2
    }} \left| R\left(\frac{v_2}{v_1},y_2,y_1\right)
    R(v_2,y_2)R\left(v_1,y_1\right)\right| dv_1 \ dv_2\\
     \ll& 
    \int_{v_1\asymp 1} |R\left(v_1,y_1\right)|
    \int\displaylimits_{\left|v_2 - \frac{v_1m_1+m_3}{-m_2}\right|\lesssim \frac{q}{|m_2|N}} \left| R\left(\frac{v_2}{v_1},y_2,y_1\right)
    R(v_2,y_2)\right|  dv_2 \ dv_1\\
    \ll& \int_{v_1\asymp 1} |R\left(v_1,y_1\right)|
    \int\displaylimits_{\left|v_2 - \frac{v_1m_1+m_3}{-m_2}\right|\lesssim \frac{q}{MN}} \left| R\left(\frac{v_2}{v_1},y_2,y_1\right)
    R(v_2,y_2)\right|  dv_2 \ dv_1\\
\end{align*}
when $|m_2|\asymp M$. The inner integral, by Cauchy-Schwarz,
is \begin{align*}
    \leq & \left(\int\displaylimits_{\left|v_2 - \frac{v_1m_1+m_3}{-m_2}\right|\lesssim \frac{q}{MN}} \left| R\left(\frac{v_2}{v_1},y_2,y_1\right)\right|^2 \ dv_2 \right)^{1/2}
    \left(
    \int\displaylimits_{\left|v_2 - \frac{v_1m_1+m_3}{-m_2}\right|\lesssim \frac{q}{MN}} \left|
    R(v_2,y_2)\right|^2  dv_2\right)^{1/2}\\
    \ll& \frac{q}{MN} \tilde{R}_M\left(\frac{v_1m_1+m_3}{-m_2v_1},y_2,y_1\right)  \tilde{R}_M(\frac{v_1m_1+m_3}{-m_2},y_2)
\end{align*}
where in the last step, we used $v_1\asymp 1$.
Thus, for $|m_2|\sim M$,
\[
|I_{m,q_0}|\lesssim \frac{N^3q_0}{q^3} \frac{q}{NM}\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} \\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}} \tilde{I}_{m,q_0}.
\]
The proposition follows from this claim.
\end{proof}
To apply H\"older's inequality, we need to find bounds on the second and fourth moments of $R(v,y_1,y_2)$.
\begin{lemma} [Second and fourth moments of $R$]\label{secondmoment}
    Let $\mathcal{S}=\{(t_j,\chi_j)\}$, such that $\chi_j$ is a character mod $q$, and the $t$'s are contained in an interval of length $T$, and are $T^\epsilon$-separated for the same character. Then uniformly in $y_2\in \mathbb{Z}/q\mathbb{Z}$, \[
        \sum_{y_1\in (\mathbb{Z}/q\mathbb{Z})} \int_{v\asymp 1} 
        \left|R\left(v,y_1,y_2\right)\right|^2dv \ll_{\epsilon} \phi(q)|\mathcal{S}|,
    \]
     and \[
        \sum_{y_1\in (\mathbb{Z}/q\mathbb{Z})} \int_{v\asymp 1} 
        \left|R\left(v,y_1,y_2\right)\right|^4dv  \lesssim \phi(q)E(\mathcal{S}).
    \]
\end{lemma}
\begin{proof}
    For the second moment, we have \[
    |R(v,y_1,y_2)|^2 = \sum_{(t_1,\chi_1),(t_2,\chi_2)\in \mathcal{S}}
    \chi_1\bar{\chi}_2(y_1)\bar{\chi}_1{\chi}_2(y_2)v^{i(t_1-t_2)}.
    \]
    By the orthogonality of characters,\[
        \sum_{y_1\in (\mathbb{Z}/q\mathbb{Z})}|R(v,y_1,y_2)|^2 = \phi(q) \sum_{(t_1,\chi_1),(t_2,\chi_2)\in \mathcal{S}} \delta_{\chi_1\chi_2}\bar{\chi}_1{\chi}_2(y_2)v^{i(t_1-t_2)} = \phi(q)\sum_{(t_1,\chi_1),(t_2,\chi_2)\in \mathcal{S}} \delta_{\chi_1\chi_2}\mathbb{I}_{(y_2,q)=1} v^{i(t_1-t_2)},
    \]
    so it is enough to consider the second moment of $R(v,y,1)$ (and $y_2$ is coprime to $q$).
    Let $\psi$ be a bump function supported on $v\asymp 1$ and equals $1$ on the domain of integration in the lemma.
   Then, \begin{align*}
        \sum_{y\in (\mathbb{Z}/q\mathbb{Z})^\times} \int_{v\asymp 1} 
        \left|R\left(v,y\right)\right|^2dv 
        \leq&\sum_{y\in (\mathbb{Z}/q\mathbb{Z})^\times} \int 
        \psi(v)\left|R\left(v,y\right)\right|^2dv 
        \\=&
        \phi(q)\int \psi(v)
        \sum_{\substack{(t_1,\chi_1),(t_2,\chi_2)\in \mathcal{S}\\ \chi_1=\chi_2}}v^{i(t_1-t_2)}
        dv\\
        =&
        \phi(q)\sum_{\substack{(t_1,\chi_1),(t_2,\chi_2)\in \mathcal{S}\\ \chi_1=\chi_2}}\int \psi(v)
        v^{i(t_1-t_2)}
        dv.
    \end{align*}
    In the sum, the terms $t_1=t_2$ contribute $O(|\mathcal{S}|)$. If $t_1\neq t_2$, then $|t_1-t_2|\geq T^\epsilon$. The integral in this case is $O_\epsilon(T^{-100})$ and is negligible.

    Similarly for the fourth moment, it is enough to consider $R(v,y)$. We have \[
    |R(v,y)|^4 = \sum_{\substack{(t_1,\chi_1),(t_2,\chi_2),\\ (t_3,\chi_3),(t_4,\chi_4)\in \mathcal{S}}}
    \chi_1{\chi}_2\bar{\chi_3}\bar{\chi_4}(y)v^{i(t_1+t_2-t_3-t_4)}.
    \]
    So again by the orthogonality of characters, \begin{align*}
        \sum_{y\in (\mathbb{Z}/q\mathbb{Z})^\times} \int_{v\asymp 1} 
        \left|R\left(v,y\right)\right|^4dv = & \phi(q)
        \sum_{\substack{(t_1,\chi_1),(t_2,\chi_2),\\ (t_3,\chi_3),(t_4,\chi_4)\in \mathcal{S}\\ \chi_1\chi_2=\chi_3\chi_4}} \int_{v\asymp 1} v^{i(t_1+t_2-t_3-t_4)} dv.
    \end{align*}
    Similar to the previous proof, we can introduce the bump function $\psi$ for the integral, and restrict the summation to the terms $|t_1+t_2-t_3-t_4|\leq T^\epsilon$ with an error of $O_\epsilon(T^{-100})$. The remaining terms in the summation contribute $O(E(\mathcal{S}))$.
\end{proof}
\begin{lemma}\label{fourthmoment_smooth}
    Let $E(\mathcal{S})=\#\{(t_1,\chi_1),(t_2,\chi_2),(t_3,\chi_3),(t_4,\chi_4)\in \mathcal{S}  :  |t_1+t_2-t_3-t_4|\leq 1, \chi_1\chi_2=\chi_3\chi_4\}$. Then \[
        \sum_{y_1\in (\mathbb{Z}/q\mathbb{Z})^\times} \int_{v\asymp 1} 
        \left|\tilde{R}_M\left(v,y_1,y_2\right)\right|^4dv  \lesssim \phi(q)E(\mathcal{S}).
    \]
\end{lemma}
\begin{proof}
    It is enough to show the case where $y_2=1$.
    We apply Cauchy-Schwarz to \begin{align*}
        \int_{v\asymp 1} 
        \left|\tilde{R}_M\left(v,y\right)\right|^4dv  \lesssim& \int_{v\asymp 1} 
        \left(\int_{|u-v|\lesssim q/NM}
        \frac{NM}{q}|R(u,y)|^2 du\right)^2
        dv \\
        \stackon{CS}{\lesssim}& \frac{NM}{q} \int_{v\asymp 1} 
       \int_{|u-v|\lesssim q/NM}
        |R(u,y)|^4 du \ 
        dv\\
        \lesssim&  
        \int_{u\asymp 1}
         |R(u,y)|^4 du.
    \end{align*}
    Lemma \ref{secondmoment} completes the proof.
\end{proof}

\begin{proof}[{Proof of Proposition \ref{s_3bound}}]
    We exchange the summation to get \begin{align*}
    &\sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M}}\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} \\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\tilde{I}_{m,q_0}\\
    =&\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\tilde{I}_{m,q_0}\\
    =&\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1} \left|R\left(v_1,y_1\right)\right|
    \sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\left| \tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2v_1},y_2,y_1\right)
    \tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2},y_2\right)\right| dv_1\\
    \stackon{CS}{\leq} & \Big(\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1} \left|R\left(v_1,y_1\right)\right|dv_1\Big)^{1/2} 
    \\ & \quad \quad\Bigg(\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1} \Big(\sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\left|\tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2v_1},y_2,y_1\right)
    \tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2},y_2\right)\right|\Big)^2 dv_1\Bigg)^{1/2}.
    \end{align*}
    The second moment of $R$ (and only considering non-zero contributions from $\gcd(q,y_1)=\gcd(q,y_2)=1$) gives \begin{align*}
        \Big(\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1} \left|R\left(v_1,y_1\right)\right|dv_1\Big)^{1/2}  \lesssim (phi(q)^2 |\mathcal{S}|)^{1/2} \ll \phi(q) |\mathcal{S}|^{1/2}. 
    \end{align*}
    We apply repeated Cauchy-Schwarz in the second term to get \begin{align*}
     &   \Bigg(\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1} \Big(\sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\Big|\tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2v_1},y_2,y_1\right)
    \tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2},y_2\right)\Big| dv_1\Big)^{2}\Bigg)^{1/2}\\
    \stackon{CS}{\leq}&\Bigg(\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1}\Big[\sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\Big|\tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2v_1},y_2,y_1\right)\Big|^2\Big]\\ & \quad \quad
   \Big[ \sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}
    \Big|\tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2},y_2\right)\Big|^2\Big] dv_1\Bigg)^{1/2}\\
    \stackon{CS}{\leq}&\Bigg(\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1}\Big[\sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\Big|\tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2v_1},y_2,y_1\right)\Big|^2\Big]^2dv_1\Bigg)^{1/4}\\ & \quad \quad
    \Bigg(\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1}\Big[ \sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}
     \Big|\tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2},y_2\right)\Big|^2\Big]^2 dv_1\Bigg)^{1/4}\\
    \end{align*}
    We focus on one term, the computation of the second term is similar. \begin{align*}
        &\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1}\Big[\sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\Big|\tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2v_1},y_2,y_1\right)\Big|^2\Big]^2dv_1\\
        \stackon{CS}{\leq}&\frac{M_1M^2}{q_0}\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1}\sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\Big|\tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2v_1},y_2,y_1\right)\Big|^4dv_1
    \end{align*}
    For any choice $m_1,m_2,m_3$, we can make the change of variables $u=(m_1v_1+m_3/(-m_2v_1))$ with a Jacbian factor of $O(1)$, and the domain of integration is still $u\asymp 1$, so \begin{align*}
        &\sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1}\sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}\Big|\tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2v_1},y_2,y_1\right)\Big|^4dv_1\\
        \ll &\frac{M_1M^2}{q_0} sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{u\asymp 1}\Big|\tilde{R}_M\left(u,y_2,y_1\right)\Big|^4du\\
        \lesssim& \frac{M_1M^2}{q_0} \phi(q)^2 E(\mathcal{S}).
    \end{align*}
    Similarly, \begin{align*}
        \sum_{\substack{y_1,y_2 \in\mathbb{Z}/q\mathbb{Z} }}\int_{v_1\asymp 1}\Big[ \sum_{\substack{|m_1|\sim M_1,|m_2|,|m_3|\sim M\\ y_1m_1+y_2m_2+m_3\equiv 0 \mod q_0}}
     \Big|\tilde{R}_M\left(\frac{m_1v_1+m_3}{-m_2},y_2\right)\Big|^2\Big]^2 dv_1\lesssim& \frac{M_1^2M^4}{q_0^2} \phi(q)^2 E(\mathcal{S}).\end{align*}

     Therefore, we have \[
     S_3\lesssim \frac{N^2q_0}{Mq^2} \phi(q) |\mathcal{S}|^{1/2}\Big(\frac{M_1^2M^4}{q_0^2} \phi(q)^2 E(\mathcal{S})\Big)^{1/2} \ll 
     \frac{N^2q_0}{Mq^2} \phi(q)^2 |\mathcal{S}|^{1/2} \frac{M_1M^2}{q_0}E(\mathcal{S})^{1/2} \lesssim\Big(\frac{\phi(q)}{q}\Big)^2(qT)^2|\mathcal{S}|^{1/2}E(\mathcal{S})^{1/2},
     \]
    where we applied $M_1\leq M\lesssim qT/N$ in the last step.
\end{proof}