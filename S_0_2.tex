\section{$S_1$ bound}
\begin{proposition}\label{s1bound}
    $S_1=O\epsilon(T^{-10})$.
\end{proposition}
\begin{proof}
    Recall that \[
    S_1=\sum_{\substack{m_1,m_2,m_3\in \mathbb{Z},\\
    \#\{m_j \ | \ m_j\neq 0\}=1}} I_m.\]
By symmetry, we sum $I_m$ across all $m=(0,0,m_3\neq 0)$ at a cost of a factor of $3$.
In this case, \begin{align*}
    I_{(0,0,m_3)}=\frac{N^3}{q^3}\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2),\\(t_3,\chi_3)\in\mathcal{S}}} &\sum_{x\in (\mathbb{Z}/q\mathbb{Z})^3}\chi_1\bar{\chi}_3(x_1)\chi_2\bar{\chi}_1(x_2)\chi_3\bar{\chi}_2(x_3) e\left(\frac{-x_3 m_3}{q}\right)\\
    \times \ &\hat{h}_{t_1-t_3}\left(0\right)\hat{h}_{t_2-t_1}\left(0\right)\hat{h}_{t_3-t_2}\left(\frac{Nm_3}{q}\right)
\end{align*}
By the orthogonality of characters, this expression vanishes when $\chi_1\neq \chi_2$ (consider summation in $x_2$) or $\chi_2\neq \chi_3$ (summation in $x_1$). Therefore, we can further restrict our summation in $\mathcal{S}$ to be over terms with $\chi_1=\chi_2=\chi_3$ to get \begin{align*}
    I_m&=\frac{N^3}{q^3}\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2=\chi_1),\\(t_3,\chi_3=\chi_1)\in\mathcal{S}}} \ \phi(q)^2 \sum_{x_3\in (\mathbb{Z}/q\mathbb{Z})^{\times}}e\left(\frac{-x_3 m_3}{q}\right)\\
   & \quad  \times  \quad {h}_{t_1-t_3}\left(0\right)\hat{h}_{t_2-t_1}\left(0\right)\hat{h}_{t_3-t_2}\left(\frac{Nm_3}{q}\right)\\
   &=O\left(\frac{N^3\phi(q)^3}{q^3}\right) \sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2=\chi_1),\\(t_3,\chi_3=\chi_1)\in\mathcal{S}}} \hat{h}_{t_1-t_3}\left(0\right)\hat{h}_{t_2-t_1}\left(0\right)\hat{h}_{t_3-t_2}\left(\frac{Nm_3}{q}\right)\\
\end{align*}
So we trivially bound $S_1$ by\begin{align*}
    |S_1|&\ll  \frac{N^3}{q^3} \phi(q)^3 \sum_{m_3\neq 0}\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2=\chi_1),\\(t_3,\chi_3=\chi_1)\in\mathcal{S}}}
   \left|\hat{h}_{t_1-t_3}\left(0\right)\hat{h}_{t_2-t_1}\left(0\right)\hat{h}_{t_3-t_2}\left(\frac{Nm_3}{q}\right)\right|\\
\end{align*}
On the right hand side, we split the sum into three parts \begin{align*}
    \frac{N^3}{q^3}\phi(q)^3(S_{1,1}+S_{1,2}+S_{1,3}),
\end{align*}
where \begin{align*}
    S_{1,1}&= \sum_{|m_3|>qT^{1+\epsilon}/N}\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2=\chi_1),\\(t_3,\chi_3=\chi_1)\in\mathcal{S}}}
    \left|\hat{h}_{t_1-t_3}\left(0\right)\hat{h}_{t_2-t_1}\left(0\right)\hat{h}_{t_3-t_2}\left(\frac{Nm_3}{q}\right)\right|,\\
    S_{1,2}&=  \sum_{|m_3|\leq qT^{1+\epsilon}/N}\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2=\chi_1),\\(t_3,\chi_3=\chi_1)\in\mathcal{S},\\ t_1\neq t_2 \ \rm{or} \ t_1\neq t_3}}
    \left|\hat{h}_{t_1-t_3}\left(0\right)\hat{h}_{t_2-t_1}\left(0\right)\hat{h}_{t_3-t_2}\left(\frac{Nm_3}{q}\right)\right|,\\
    S_{1,3}&= \sum_{|m_3|\leq qT^{1+\epsilon}/N}\sum_{(t,\chi)\in\mathcal{S}}
    \left|\hat{h}_{0}\left(0\right)\hat{h}_{0}\left(0\right)\hat{h}_{0}\left(\frac{Nm_3}{q}\right)\right|.
\end{align*}
We now apply \hyperref[nonstationary]{Non-Stationary Phase} to $\hat{h}$. In $S_{1,1}$, we consider the terms with $|m_3|>qT^{1+\epsilon}/N$, we have decay in \[
    \hat{h}_{t_3-t_2}\ll_{A}\left(\frac{Nm_3}{q}\right)\left(1+|t_3-t_2|\right)^A\left(\frac{N|m_3|}{q}\right)^{-A} \ll T^A \left(T^{1+\epsilon}\right)^{-A} \left(\frac{N|m_3|}{qT^{1+\epsilon}}\right)^{-A}.
\] Therefore, we trivially bound $\hat{h}_t{\xi}\ll 1$ to obtain a bound of $O_\epsilon(T^{-100})$ for the sum across $|m_3|>qT^{1+\epsilon}/N$.
Similarly, for $S_{1,2}$  with terms consisting $t_1\neq t_2$ or $t_1\neq t_3$, they will be $T^\epsilon$ apart, so $h_{t_2-t_1}(0)$ or $h_{t_1-t_3}(0)$ can be bounded by $O_{\epsilon}(T^{-100})$.

The final terms to bound are when $t_1=t_2=t_3$ in $S_{1,3}$, in which case \[
    \left|\hat{h}_{t_3-t_2}\left(\frac{Nm_3}{q}\right)\right| \ll_{A} \left(\frac{q}{N}\right)^{A}\ll_{\epsilon} T^{-100}.
\]
Combined, the contribution of $S_1$ is $O\epsilon(T^{-10})$.

\end{proof}


\section{$S_2$ bound}
\begin{proposition}\label{s2bound}
    We have for any integer $k$,
    \[
    S_2\lesssim_k |\mathcal{S}|^2N+|\mathcal{S}|^{2-1/k}N^2+|\mathcal{S}|^2N^2\Big(\frac{(qT)^{1/2}}{|\mathcal{S}^{3/4}|}\Big)^{1/k}.
    \]
\end{proposition}

\begin{lemma}
    We have 
    \[
    S_2 = 3\frac{N^3}{q^3} \phi(q) \hat{h}_{0}\left(0\right) \sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2)\in\mathcal{S}}} \left|\sum_{m\neq 0} \sum_{x \in \mathbb{Z}/q\mathbb{Z}}\chi_1\bar{\chi}_2(x) e\left(\frac{-mx}{q}\right)
     \hat{h}_{t_1-t_2}\left(\frac{Nm}{q}\right)\right|^2 + O(T^{-10}).
\]
\end{lemma}
\begin{proof}
    We write by symmetry \begin{align*}
        S_2= 3\frac{N^3}{q^3}\sum_{m_1,m_2\neq 0}\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2),\\(t_3,\chi_3)\in\mathcal{S}}} &\sum_{x\in (\mathbb{Z}/q\mathbb{Z})^3}\chi_1\bar{\chi}_3(x_1)\chi_2\bar{\chi}_1(x_2)\chi_3\bar{\chi}_2(x_3) e\left(\frac{-x_1m_1-x_2m_2}{q}\right)\\
        \times \ &\hat{h}_{t_1-t_3}\left(\frac{Nm_1}{q}\right)\hat{h}_{t_2-t_1}\left(\frac{Nm_2}{q}\right)\hat{h}_{t_3-t_2}\left(0\right)
    \end{align*}
    Removing zero contributions from $\chi_2\neq \chi_3$ by orthogonality,
    we have \begin{align*}
        =3\frac{N^3}{q^3} \phi(q) \sum_{m_1,m_2\neq 0}\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2),\\(t_3,\chi_3=\chi_2)\in\mathcal{S}}} &\sum_{x_1,x_2 \in \mathbb{Z}/q\mathbb{Z}}\chi_1\bar{\chi}_2(x_1)\chi_2\bar{\chi}_1(x_2) e\left(\frac{-x_1m_1-x_2m_2}{q}\right)\\
        \times \ &\hat{h}_{t_1-t_3}\left(\frac{Nm_1}{q}\right)\hat{h}_{t_2-t_1}\left(\frac{Nm_2}{q}\right)\hat{h}_{t_3-t_2}\left(0\right)
    \end{align*}
    Here, we can isolate contributions from the terms where $t_2\neq t_3$ (hence since $\chi_2=\chi_3$, are $T^{\epsilon}$ separated) to be $O(T^{-10})$. For the other terms, we can write
    \[
        \hat{h}_t(\xi) = \overline{\hat{h}_{-t}(-\xi)}
    \]
    to get 
    \iffalse
    $S_2$
    \begin{align*}
        = 3\frac{N^3}{q^3} \hat{h}_{0}\left(0\right)\phi(q) \sum_{m_1,m_2\neq 0}\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2)\in\mathcal{S}}} &\sum_{x_1,x_2 \in \mathbb{Z}/q\mathbb{Z}}\chi_1\bar{\chi}_2(x_1)\chi_2\bar{\chi}_1(x_2) e\left(\frac{-x_1m_1-x_2m_2}{q}\right)\\
        \times \ &\hat{h}_{t_1-t_2}\left(\frac{Nm_1}{q}\right)\hat{h}_{t_2-t_1}\left(\frac{Nm_2}{q}\right)
    \end{align*}
    and by 
    
    we can rewrite this to get
    \fi
    \[
        S_2 = 3\frac{N^3}{q^3} \phi(q) \hat{h}_{0}\left(0\right) \sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2)\in\mathcal{S}}} \left|\sum_{m\neq 0} \sum_{x \in \mathbb{Z}/q\mathbb{Z}}\chi_1\bar{\chi}_2(x) e\left(\frac{-mx}{q}\right)
         \hat{h}_{t_1-t_2}\left(\frac{Nm}{q}\right)\right|^2 + O(T^{-10}).
    \]
\end{proof}
\begin{proof}[Proof of Proposition \ref{s2bound}]
    By the principle of non-stationary phase the terms where $(t_1,\chi_1)=(t_2,\chi_2)$ contribute $O(T^{-10})$. If $\chi_1\neq \chi_2$, then we can apply the orthogonality of characters to extend the summation in $m$ to include $m=0$ too. Lastly, if $\chi_1=\chi_2$ and $t_1\neq t_2$, we add the negligible term corresponding to $m=0$, as $\hat h_{t_1-t_2}(0)$ is negligble.
    Therefore, we have \begin{align*}
        S_2&\ll \frac{N^3}{q^3} \phi(q) \sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2)\in\mathcal{S}\\ (t_1,\chi_1)\neq (t_2,\chi_2)}} \left|\sum_{m\neq 0} \sum_{x \in \mathbb{Z}/q\mathbb{Z}}\chi_1\bar{\chi}_2(x) e\left(\frac{-mx}{q}\right)
        \hat{h}_{t_1-t_2}\left(\frac{Nm}{q}\right)\right|^2 + O(T^{-10})\\ 
        &\stackeq{Poisson} \quad \frac{N}{q} \phi(q) \sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2)\in\mathcal{S}\\ (t_1,\chi_1)\neq (t_2,\chi_2)}} \left|\sum_{n\sim N} \chi_1\bar\chi_2(n)\omega\left(\frac{n}{N}\right)^2\left(\frac{n}{N}\right)^{i(t_1-t_2)}\right|^2 + O(T^{-10})\\
        &=\frac{N}{q} \phi(q) \sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2)\in\mathcal{S}\\ (t_1,\chi_1)\neq (t_2,\chi_2)}} \left|\sum_{n\sim N} \chi_1\bar\chi_2(n)\omega\left(\frac{n}{N}\right)^2n^{i(t_1-t_2)}\right|^2 + O(T^{-10})\\
        & \leq \frac{N}{q} \phi(q) \sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2)\in\mathcal{S}}} \left|\sum_{n\sim N} \chi_1\bar\chi_2(n)\omega\left(\frac{n}{N}\right)^2n^{i(t_1-t_2)}\right|^2 + O(T^{-10}).
    \end{align*}
    Before we apply Heath-Brown's theorem, we use H\"older's inequality to get \begin{align*}
        \sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2)\in\mathcal{S}}} \left|\sum_{n\sim N} \chi_1\bar\chi_2(n)\omega\left(\frac{n}{N}\right)^2n^{i(t_1-t_2)}\right|^2\leq \left(\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2)\in\mathcal{S}}} 1\right)^{(k-1)/k}\left(\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2)\in\mathcal{S}}} \left|\sum_{n\sim N} \chi_1\bar\chi_2(n)\omega\left(\frac{n}{N}\right)^2n^{i(t_1-t_2)}\right|^{2k}\right)^{1/k}\\
        =|\mathcal{S}|^{2-2/k}\left(\sum_{\substack{(t_1,\chi_1),\\(t_2,\chi_2)\in\mathcal{S}}} \left|\sum_{n\asymp_k N^k} O(d(n))\chi_1\bar\chi_2(n)n^{i(t_1-t_2)}\right|^{2k}\right)^{1/k}.
    \end{align*}
    As the divisor is bounded by $d(n)=N^{o(1)}$, we apply \hyperref[heathbrown]{Heath-Brown's theorem} to bound the second term by \[
    \lesssim_k (|\mathcal{S}|^2N^k+|\mathcal{S}|N^{2k}+|\mathcal{S}|^{5/4}(qT)^{1/2}N^k)^{1/k}\ll_k|\mathcal{S}|^{2k}N+|\mathcal{S}^{1/k}|N^{2}+|\mathcal{S}|^{5/(4k)}(qT)^{1/(2k)}N.
    \]
    Therefore, combined with the previous bound on $S_2$, we have \[
    S_2\lesssim \frac{N}{q} \phi(q)|\mathcal{S}|^{2-2/k}(|\mathcal{S}|^{2k}N+|\mathcal{S}^{1/k}|N^{2}+|\mathcal{S}|^{5/(4k)}(qT)^{1/(2k)}N)
    \]
    which gives the proposition upon simplification.
\end{proof}
\iffalse by decay in $Nm/q$. \textit{We also used the fact that there are at most $\phi(q)$ characters mod $q$, so the $O(q^2)$ factor is negligible compared to $N^{-100}$}.

For the other terms where $t_1$ and $t_2$ are $T^\epsilon$ separated or $\chi_1\neq \chi_2$, we want to apply Heath Brown's theorem. 
\begin{lemma}
    Let $t>T^\epsilon$ or $\chi$ be a non-primitive character mod $q$.
    \[
        \sum_{m\neq 0} \sum_{x \in \mathbb{Z}/q\mathbb{Z}}\chi(x) e\left(\frac{-mx}{q}\right)
        \hat{h}_{t}\left(\frac{Nm}{q}\right)\ll ?
    \]
\end{lemma}
\begin{proof}
    If $\chi$ is not primitive, then \[
        \sum_{m\neq 0} \sum_{x \in \mathbb{Z}/q\mathbb{Z}}\chi(x) e\left(\frac{-mx}{q}\right)
        \hat{h}_{t}\left(\frac{Nm}{q}\right)=\sum_{m\in \mathbb{Z}} \sum_{x \in \mathbb{Z}/q\mathbb{Z}}\chi(x) e\left(\frac{-mx}{q}\right)
        \hat{h}_{t}\left(\frac{Nm}{q}\right)
    \] by the orthogonality of characters.
    When $t_1,t_2$ are at $T^\epsilon$ separated, we can add in the terms $\hat{h}_{t_1-t_2}(0)$ corresponding to $m=0$, at the cost of $O_\epsilon(T^{-100})$. Therefore, we can consider the sum across all $m\in\mathbb{Z}$ with an error of $O_\epsilon(T^{-100})$. Let $W$ be the Mellin transform of the function $\omega(x)^2$. So that
\begin{align*}
    &\frac{N^{1+it}}{q}\sum_{m\in \mathbb{Z}} \sum_{x \mod q}\chi(x) e\left(\frac{-mx}{q}\right)
    \hat{h}_{t}\left(\frac{Nm}{q}\right) \\
    =& \sum_{n} n^{it}\chi(n)\omega\left(\frac{n}{N}\right)^2\\
    =& \frac{1}{2\pi i}\int_{2-i\infty}^{2+i\infty}W(s)N^s \sum_n n^{-s+it}\chi(n) ds\\
    =& \frac{1}{2\pi i}\int_{2-i\infty}^{2+i\infty}W(s)N^s L(s-it,\chi) ds\\
    =& \frac{1}{2\pi i}\int_{-1-i\infty}^{-1+i\infty}W(s)N^sL(s-it,\chi) ds + \varepsilon(\chi)\frac{\phi(q)}{q}N^{1+it}W(1+it)
\end{align*}
where $\varepsilon$ detects if $\chi$ is principal or not. The second term arising from the (potential) pole at $1$ decays quickly so is $O_{\epsilon}(T^{-100})$ for $t>T^\epsilon$. If $\chi$ is not principal, the contribution is $0$. Therefore, this term is negligible. 
For the first term, we let $\chi$ be induced by the primitive $\chi^*$ with modulus $r$, so\[
    L(s-it,\chi)=L(s-it,\chi^*)\prod_{p|q} \left(1-\frac{\chi^*(p)}{p^s}\right).
\]
We also let \[
    G(s) =\frac{\tau(\chi^*)}{i^\delta\sqrt{r}}r^{1/2-s}\pi^{s-1/2}\frac{\Gamma(\frac{1-s+\delta}{2})}{\Gamma(\frac{s+\delta}{2})},
\]
so that $L(s-it,\chi^*)(s) = G(s-it)L(1-s+it,\overline{\chi^*})$. The integral becomes
\begin{align*}
   &\frac{1}{2\pi i}\int_{-1-i\infty}^{-1+i\infty}W(s)N^sL(s-it,\chi) ds \\=&\frac{1}{2\pi i}
   \int_{-1-i\infty}^{-1+i\infty}W(s)N^s
    G(s-it) L(1-s+it,\overline{\chi^*}) \prod_{p|q} \left(1-\frac{\chi^*(p)}{p^s}\right)ds\\
    =& \frac{1}{2\pi i}\int_{-1-i\infty}^{-1+i\infty}W(s)N^s
    G(s-it) 
    \left(\sum_{n\leq M}\frac{\overline{\chi^*}(n)}{n^{1-s+it}}+
    \sum_{n> M}\frac{\overline{\chi^*}(n)}{n^{1-s+it}}
   \right) \prod_{p|q} \left(1-\frac{\chi^*(p)}{p^s}\right)ds
\end{align*}
Where $M$ is a parameter to be determined. The summation is convergent as the real part is larger than $1$.
We thus break up the integral into two pieces according to the two summations $I_1+I_2$. Moving the line of integration of $I_1$ to $\Re(s)=1$ and $I_2$ to $\Re(s)=-2k$,
\begin{align*}
        I_1&= \frac{1}{2\pi}\int_{-\infty}^{\infty}W(1+iu)N^{1+iu}G(1+iu-it)\sum_{n\leq M}\overline{\chi^*}(n)n^{-i(u-t)}\prod_{p|q} \left(1-\frac{\chi^*(p)}{p^{1+iu}}\right)du,\\
        I_2&= \frac{1}{2\pi}\int_{-\infty}^{\infty}W(-2k+iu)N^{-2k+iu}G(-2k+iu-it)\sum_{n> M}\overline{\chi^*}(n)n^{-2k-1-i(u-t)}\prod_{p|q} \left(1-\frac{\chi^*(p)}{p^{-2k+iu}}\right)du.
\end{align*}
By the decay of $W$, we can truncate both integrals to the region $|u|\ll T^\epsilon$.
Moreover, by \textbf{Davenport multiplicative number theory chp 10}
we have \begin{align*}
    \frac{\Gamma\left(\frac{i(t-u)+\delta}{2}\right)}{\Gamma\left(\frac{1+i(u-t)+\delta}{2}\right)}\ll \frac{1}{t^{1/2}} \frac{1}{}
\end{align*}
\end{proof}
\fi